<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard SSCD</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="data.js"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; text-align: center; padding: 30px; }
    canvas { background: white; border: 1px solid #ccc; margin-bottom: 30px; }
  </style>
</head>
<body>
  <h1>Tableau de bord SSCD</h1>

  <div>
    <canvas id="cpuChart" width="900" height="300"></canvas>
    <canvas id="ramChart" width="900" height="300"></canvas>
    <canvas id="loadChart" width="900" height="300"></canvas>
  </div>

  <p id="lastUpdate">Dernière mise à jour : --</p>

  <script>
    async function fetchAndRender() {
      const res = await fetch("data.js");
      const jsText = await res.text();
      eval(jsText); // charge metricsData[]

      const labels = metricsData.map(pt => pt.time);
      const cpu = metricsData.map(pt => pt.CPU);
      const ram = metricsData.map(pt => pt.RAM);
      const load = metricsData.map(pt => pt.LOAD);
      const alerts = metricsData
        .map((pt, i) => pt.alert ? { x: pt.time, y: pt.CPU } : null)
        .filter(p => p);

      function buildChart(id, label, data, alertPoints, color) {
        const ctx = document.getElementById(id).getContext('2d');
        if (window[id]) window[id].destroy();
        window[id] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: label,
                data: data,
                borderColor: color,
                backgroundColor: color.replace("1)", "0.2)"),
                fill: true,
                tension: 0.3
              },
              ...(alertPoints.length > 0 && id === "cpuChart" ? [{
                label: "CPU ALERT",
                data: alertPoints,
                type: "scatter",
                backgroundColor: "red",
                pointRadius: 5
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
              x: { ticks: { maxRotation: 60, minRotation: 30 } }
            }
          }
        });
      }

      buildChart("cpuChart", "CPU (%)", cpu, alerts, "rgba(0,123,255,1)");
      buildChart("ramChart", "RAM utilisée (%)", ram, [], "rgba(40,167,69,1)");
      buildChart("loadChart", "Load Average (1min)", load, [], "rgba(255,193,7,1)");

      document.getElementById("lastUpdate").textContent =
        "Dernière mise à jour : " + new Date().toLocaleTimeString();
    }

    fetchAndRender();
    setInterval(fetchAndRender, 30000);
  </script>
</body>
</html>
